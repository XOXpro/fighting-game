// Creating variables
let canvasX=1535,canvasY=721;
let p1={
    x:200,y:0,dx:0,dy:0,onground:0,dir:1,hp:1000,inframe:0,c:1
},p2={
    x:canvasX-100-150,y:0,dx:0,dy:0,onground:0,dir:-1,hp:1000,inframe:0,c:1
},
walls=[{
    x:100,y:canvasY-200,x1:canvasX-100-100,y1:100
},{
    x:200,y:250,x1:350,y1:50
},{
    x:canvasX-200-350,y:250,x1:350,y1:50
},{
    x:canvasX/2-350/2,y:50,x1:350,y1:50
}]
let t=1000,t2=0,t3=-69420,ex=[],ey=[],ed=[],en=0,ecd=1000,ecd2=0,mx=69420,my=69420,mx2=69420,my2=69420,mx3=69420,my3=69420,nx=[],ny=[],nd=[],nn=0,rd=-100,ecd3=0,tick=0,g1=0.1,bx=-69,by=-420,bt=-69,btdt=-69,ha=0, blet=false,bd=-10,annya=false
function sound(src) {
  this.sound = document.createElement("audio");
  this.sound.src = src;
  this.sound.setAttribute("preload", "auto");
  this.sound.setAttribute("controls", "none");
  this.sound.style.display = "none";
  document.body.appendChild(this.sound);
  this.play = function(){
    this.sound.play();
  }
  this.stop = function(){
    this.sound.pause();
  }
}
muda=new sound("muda.mp3")
roadroller2=new sound("roadroller2.mp3")
ts=new sound("ts.mp3")
zawardo=new sound("zawardo.mp3")
emeraldsplash20=new sound("emeraldsplash20.mp3")
emeraldsplash=new sound("emeraldsplash.mp3")
knifesfx=new sound("knifesfx.mp3")
hit=new sound("hit.wav")
ez=new sound("ez.mp3")
tsknifes=new sound("tsknifes.mp3")
boom=new sound("boom.mp3")
btd=new sound("btd.mp3")
click=new sound("click.mp3")
timeresume=new sound("timeresume.mp3")
shas=new sound("shas.mp3")
function update() {
	// Napisanoto tuk se izpulnqva otnovo i otnovo mnogo puti v sekunda
    annya=false;
    ha--
    bd--
    if(t2>0){p2.dy=0}
    tick++
    if(t2<0){
        p2.x+=p2.dx
        p2.y+=p2.dy
    }
    p1.x+=p1.dx
    p1.y+=p1.dy
    t+=1
    t2-=1
    if(t2<-1){
        t2=-1
    }
    ecd+=1
    //ecd+=20
    ecd2+=1
    ecd3-=1
    if(ecd2>0){
        ecd2=0
    }
    btdt--
    t3--
    rd--
    bt--
    p1.inframe-=1
    p2.inframe-=1
    if(t2<0){
        for(i=0;i<ex.length;i++){
            ex[i]+=ed[i]
        }
    }
    
    if(t2<50){
        for(i=0;i<nx.length;i++){
            nx[i]+=nd[i]
        }
    }
    p1.onground=0
    p2.onground=0
    for(let i = 0;i<walls.length;i++){
        if(p1.hp>0){
            if(areColliding(p1.x,p1.y,50,50,walls[i].x+1,walls[i].y,walls[i].x1-2,1)){
                p1.y=walls[i].y-50
                if(p1.dy>=0){
                    p1.dy=0
                }
                p1.onground=1
            }
            if(areColliding(p1.x,p1.y,50,50,walls[i].x+1,walls[i].y+walls[i].y1-1,walls[i].x1-2,1)){
                p1.y=walls[i].y+walls[i].y1
                if(p1.dy<=0){
                    p1.dy=0
                }
                p1.onground=2
            }
            if(areColliding(p1.x,p1.y,50,50,walls[i].x,walls[i].y+1,1,walls[i].y1-2)){
                p1.x=walls[i].x-50
                if(p1.dx>=0){
                    p1.dx=0
                }
                p1.onground=2
            }
            if(areColliding(p1.x,p1.y,50,50,walls[i].x+walls[i].x1-1,walls[i].y+1,1,walls[i].y1-2)){
                p1.x=walls[i].x+walls[i].x1
                if(p1.dx>=0){
                    p1.dx=0
                }
                p1.onground=2
            }
        }
        if(p2.hp>0){
            if(areColliding(p2.x,p2.y,50,50,walls[i].x+1,walls[i].y,walls[i].x1-2,1)){
                p2.y=walls[i].y-50
                if(p2.dy>=0){
                    p2.dy=0
                }
                p2.onground=1
            }
            if(areColliding(p2.x,p2.y,50,50,walls[i].x+1,walls[i].y+walls[i].y1-1,walls[i].x1-2,1)){
                p2.y=walls[i].y+walls[i].y1
                if(p2.dy<=0){
                    p2.dy=0
                }
                p2.onground=2
            }
            if(areColliding(p2.x,p2.y,50,50,walls[i].x,walls[i].y+1,1,walls[i].y1-2)){
                p2.x=walls[i].x-50
                if(p2.dx>=0){
                    p2.dx=0
                }
                p2.onground=2
            }
            if(areColliding(p2.x,p2.y,50,50,walls[i].x+walls[i].x1-1,walls[i].y+1,1,walls[i].y1-2)){
                p2.x=walls[i].x+walls[i].x1
                if(p2.dx>=0){
                    p2.dx=0
                }
                p2.onground=2
            }
        }
    }
    blet=false
    if(p1.c==3){
        if(isKeyPressed[32]){
            if(t>2){
                t-=2
                blet=true
            }
        }
    }
    if(true){
        //player collissions
        if(areColliding(p1.x,p1.y+50-8,50,8,p2.x,p2.y,50,8)){
            if(p2.inframe<0){
                if(p1.dy>10){
                    p2.hp-=15
                    if(p1.x>p2.x){p2.dx=-4}else if(p1.x<p2.x){p2.dx=4}else if(p1.x==p2.x){p2.hp-=15}
                    p2.inframe=25
                    hit.play()
                }
            }
        }
        if(areColliding(p2.x,p2.y+50-8,50,8,p1.x,p1.y,50,8)){
            if(p1.inframe<0){
                if(p2.dy>10){
                    if(annya==true){p1.hp-=1000000000000000}
                    p1.hp-=15
                    if(p2.c==2){
                        p1.hp-=0
                        p1.hp-=ecd/13
                        ecd=0
                    }
                    if(p2.x>p1.x){p1.dx=-4}else if(p2.x<p1.x){p1.dx=4}else if(p1.x==p2.x){p1.hp-=15}
                    p1.inframe=25
                    hit.play()
                }
            }
        }
        
        
        //emeralds
        for(i=0;i<ex.length;i++){
            if(areColliding(p1.x,p1.y,50,50,ex[i],ey[i],25,25)){
                if(p1.inframe<0){
                    p1.hp-=3
                    p1.dx+=ed[i]/45
                    ex[i]=69420106
                    ey[i]=69420106
                }
            }
        }
        
        //hankini ju metaro emeraldo splashu
        if(areColliding(p1.x,p1.y,50,50,mx,my+50,300,250)){
            if(p1.inframe<0&&t2<0){
                p1.hp-=10
                p1.inframe=10
            }
            p1.dx=0
            p1.dy=0
        }
        
        if(areColliding(p1.x,p1.y,50,50,mx3,my3+50,500,450)){
            p1.dx=0
            p1.dy=0
        }
        
        //hankini ju metaro emeraldo splashu2
        if(areColliding(p1.x,p1.y,50,50,mx2,my2+50,600,550)){
            if(p1.inframe<0&&t2<0){
                p1.hp-=2.5
                p1.inframe=10
            }
            p1.dx=0
            p1.dy=0
        }
        
        //knifes
        for(i=0;i<nx.length;i++){
            if(areColliding(p2.x,p2.y,50,50,nx[i],ny[i],25,25)){
                p2.hp-=2
                p2.dx+=nd[i]/45
                nx[i]=69420106
                ny[i]=69420106
                p2.onground=0
                p2.dy=0
            }
        }
        
        if(rd>90&&rd<950){
            if(areColliding(p2.x,p2.y,50,50,p1.x-150,p1.y-100+20,350,150)){
                if(p2.inframe<0){
                    p2.hp-=1
                    p2.inframe=1.75
                }
            }
        }
        if(rd>0&&rd<50){
            if(areColliding(p2.x,p2.y,50,50,p1.x-150,p1.y-100+20,350,150)){
                if(p2.inframe<0){
                    p2.hp-=75
                    p2.inframe=75
                    if(p1.x>p2.x){p2.dx=-6}else if(p1.x<p2.x){p2.dx=6}else if(p1.x==p2.x){p2.hp-=15}
                }
            }
        }
        if(bt>0){
            if(areColliding(p2.x,p2.y,50,50,bx-150,by-150,300,300)){
                if(p2.inframe<0){
                    p2.hp-=75
                    p2.inframe=75
                    if(bx>p2.x){p2.dx=-6}else if(bx<p2.x){p2.dx=6}else if(bx==p2.x){p2.hp-=15}
                    if(by<p2.y){p2.dy=-5}else if(by>p2.y){p2.dy=5}else if(by==p2.y){p2.hp-=15}
                }
            }
            
        }
        if(ha>0){
            if(areColliding(p2.x,p2.y,50,50,p1.x,p1.y,50,50)){
                ha=0
                bx=p1.x
                by=p1.y
                p2.hp-=75
                bt=15
            }
        }
        if(blet){
           if(p1.dir==1){
                if(areColliding(p2.x,p2.y,50,50,p1.x+50,p1.y-50,600,150)){
                    if(p2.inframe<0){
                        p2.hp--
                        p2.inframe=2
                    }
                    p2.x+=p1.dir*2
                }
           }
           if(p1.dir==-1){
                if(areColliding(p2.x,p2.y,50,50,p1.x-600,p1.y-50,600,150)){
                    if(p2.inframe<0){
                        p2.hp--
                        p2.inframe=2
                    }
                    p2.x+=p1.dir*2
                }
           }
        }
    }
    
    if(ecd3>0){
        if(tick%7==0){
            ex[en]=-50
            ey[en]=p1.y+12.5+randomInteger(20)-10
            ed[en]=20
            en++
            ex[en]=canvasX+500
            ey[en]=p1.y+12.5+randomInteger(20)-10
            ed[en]=-20
            en++
        }
        
    }
    
    p1.dy+=g1
    if(p1.dy>15){
        p1.dy=15
    }
    if(p1.dy<-8){
        p1.dy=-8
    }
    if(p1.dx>6){
        p1.dx=6
    }
    if(p1.dx<-6){
        p1.dx=-6
    }
    if(p1.dx>0){
        p1.dx-=0.1
    }
    if(p1.dx<0){
        p1.dx+=0.1
    }
    if(p1.dx>-1){
        if(p1.dx<1){
            p1.dx=0
        }
    }
    if(p1.dy>-0.1){
        if(p1.dy<0.1){
            p1.dy=0
        }
    }
    
    if(t2<0){
        p2.dy+=0.1
    }
    if(p2.dy>15){
        p2.dy=15
    }
    if(p2.dy<-8){
        p2.dy=-8
    }
    if(t2<0){
        if(p2.dx>6){
            p2.dx=6
        }
        if(p2.dx<-6){
            p2.dx=-6
        }
    }
    if(p2.dx>0){
        p2.dx-=0.1
    }
    if(p2.dx<0){
        p2.dx+=0.1
    }
    if(p2.dx>-1){
        if(p2.dx<1){
            p2.dx=0
        }
    }
    if(p2.dy>-0.1){
        if(p2.dy<0.1){
            p2.dy=0
        }
    }
    
    
    if(isKeyPressed[37]){
        if(p2.dx>-3.75){
            p2.dx-=1.1
        }
        p2.dir=-1
    }
    if(isKeyPressed[39]){
        if(p2.dx<3.75){
            p2.dx+=1.1
        }
        p2.dir=1
    }
    if(isKeyPressed[38]){
        if(p2.onground==1){
            p2.dy-=7
        }
        if(p2.onground==2){
            p2.dy-=5
        }
    }
    
    if(rd<0||rd>950){
        if(blet==false){
            if(bd<0){
                if(isKeyPressed[65]){
                    if(p1.dx>-3.75){
                        p1.dx-=1.1
                    }
                    p1.dir=-1
                }
                if(isKeyPressed[68]){
                    if(p1.dx<3.75){
                        p1.dx+=1.1
                    }
                    p1.dir=1
                }
            }
            if(isKeyPressed[87]){
                if(p1.onground==1){
                    p1.dy-=7
                }
                if(p1.onground==2){
                    if(ha<0){
                        p1.dy-=5
                    }
                }
            }
            if(isKeyPressed[83]){
                if(p1.onground==false){
                    p1.dy=15
                }
            }
        }
    }
    if(t2<0){
        if(isKeyPressed[40]){
            if(p2.onground==false){
                p2.dy=15
            }
        }
    }
    if(ecd2>-1){
        mx=69420
        my=69420
        mx2=69420
        my2=69420
    }
    if(ecd3<0){
        mx3=69420
        my3=69420
    }
    if(ecd>4000){ecd=4000}
    if(t>4000){t=4000}
    if(rd==0){p1.y-=150;p1.dy=-5}
    if(rd>100){p1.y+=randomInteger(9)-4}
    if(rd>75&&rd<90){p1.dy=-3}
    if(rd==950){p1.y+=100;p1.dy=5}
    if(rd==785){muda.play()}
    if(t3==0){t2=1000}
    if(bt==-1){bx=69420}
    if(btdt==0){
                p1.x=200
                p1.y=0
                p2.x=canvasX-100-150
                p2.y=0
                p2.hp-=100
                p1.hp+=100
                }
    if(btdt==15){
                bx=p2.x
                by=p2.y
                bt=15
                }
    if(ha>0){p1.inframe=1}
    if(bd==0){
        
        while(t>100){
            t-=100
            nx[nn]=p1.x+randomInteger(100)-50
            ny[nn]=p1.y+randomInteger(60)-30
            nd[nn]=p1.dir*25
            nn++
            nx[nn]=p1.x+randomInteger(100)-50
            ny[nn]=p1.y+12.5+randomInteger(60)-30
            nd[nn]=p1.dir*25
            nn++
            nx[nn]=p1.x+randomInteger(100)-50
            ny[nn]=p1.y+12.5+12.5+randomInteger(60)-30
            nd[nn]=p1.dir*25
            nn++
            nx[nn]=p1.x+randomInteger(100)-50
            ny[nn]=p1.y+12.5+12.5+12.5+randomInteger(60)-30
            nd[nn]=p1.dir*25
            nn++
        }
    }
    if(t2==100&&rd<0){
        timeresume.play()
    }
    if(bt==15){boom.play()}
    if(annya){p2.inframe=69}
};
function draw() {
    // tuk naprogramirai kakvo da se risuva
    if(t2>-1){
        context.fillStyle='gray'
        context.fillRect(0,0,69420,69420)
    }
    
   if(rd<0||rd>950){
       if(ha>0){
            if(p1.dir==1){
                drawImage(sha,p1.x,p1.y,50,50)
            }
            if(p1.dir==-1){
                drawImage(sha2,p1.x,p1.y,50,50)
            }
       }else{
           if(blet){
               if(tick%20>10){
                   if(p1.dir==1){
                        drawImage(bullet1,p1.x+50,p1.y-50,600,150)
                   }
                   if(p1.dir==-1){
                        drawImage(bullet1a,p1.x-600,p1.y-50,600,150)
                   }
               }else if(tick%20<10){
                   if(p1.dir==1){
                        drawImage(bullet2,p1.x+50,p1.y-50,600,150)
                   }
                   if(p1.dir==-1){
                        drawImage(bullet2a,p1.x-600,p1.y-50,600,150)
                   }
                   
               }
           }
            if(p1.hp>100){
                if(p1.dir==1){
                    drawImage(p1right,p1.x,p1.y,50,50)
                }
                if(p1.dir==-1){
                    drawImage(p1left,p1.x,p1.y,50,50)
                }
            }else{
                if(p1.dir==1){
                    drawImage(p1rightbloody,p1.x,p1.y,50,50)
                }
                if(p1.dir==-1){
                    drawImage(p1leftbloody,p1.x,p1.y,50,50)
                }
            }
            context.opacity=0.1
            if(p1.inframe>-1){
                drawImage(dmg,p1.x,p1.y,50,50)
            }
            context.opacity=1
       }
   }
    if(annya){
        if(p2.dir==1){
            drawImage(anya,p2.x,p2.y,50,50)
        }
        if(p2.dir==-1){
            drawImage(anya2,p2.x,p2.y,50,50)
        }
        
    }else{
        if(p2.hp>100){
            if(p2.dir==1){
                drawImage(p2right,p2.x,p2.y,50,50)
            }
            if(p2.dir==-1){
                drawImage(p2left,p2.x,p2.y,50,50)
            }
        }else{
            if(p2.dir==1){
                drawImage(p2rightbloody,p2.x,p2.y,50,50)
            }
            if(p2.dir==-1){
                drawImage(p2leftbloody,p2.x,p2.y,50,50)
            }
        }
        context.opacity=0.5
        if(p2.inframe>-1){
            drawImage(dmg,p2.x,p2.y,50,50)
        }
        context.opacity=1
    }   
    
    context.fillStyle='blue'
    context.fillRect(1000*0.25+0,850,t*0.25,50)
    context.fillRect(1000*0.25+0,850,t2*-0.25,50)
    context.fillStyle='purple'
    if(p1.c==1){
        context.fillRect(1000*0.25+100*0.25,845,5,60)
        context.fillRect(1000*0.25+2500*0.25,845,5,60)
        context.fillRect(1000*0.25+500*0.25,845,5,60)
    }else if(p1.c==2){
        context.fillRect(1000*0.25+500*0.25,845,5,60)
        context.fillRect(1000*0.25+2000*0.25,845,5,60)
    }
    context.fillRect(1000*0.25,845,5,60)
    context.fillRect(4000*0.25+1000*0.25,845,5,60)
    
    context.fillStyle="green"
    context.fillRect(0,790,p1.hp*1.5,50)
    context.fillRect(0,730,p2.hp*1.5,50)
    
    context.fillStyle='blue'
    context.fillRect(1000*0.25,650,ecd*0.25,50)
    context.fillRect(1000*0.25,650,ecd2*0.25,50)
    context.fillStyle='purple'
    if(p2.c==1){
        context.fillRect(1000*0.25+100*0.25,645,5,60)
        context.fillRect(1000*0.25+1000*0.25,645,5,60)
        context.fillRect(1000*0.25+1500*0.25,645,5,60)
    }
    context.fillRect(1000*0.25,645,5,60)
    context.fillRect(4000*0.25+1000*0.25,645,5,60)
    for(i=0;i<ex.length;i++){
        drawImage(emerald,ex[i],ey[i],25,25)
    }
    for(i=0;i<nx.length;i++){
        if(nd[i]>0){
            drawImage(knife,nx[i],ny[i],25,25)
        }else{
            drawImage(knife2,nx[i],ny[i],25,25)
        }
    }
    drawImage(meter,mx,my,300,300)
    drawImage(meter,mx2,my2,650,650)
    drawImage(meter,mx3,my3,550,550)
    if(rd>0&&rd<950){
        if(p1.hp>100){
            if(p1.dir==1){
                drawImage(p1right,p1.x,p1.y-150+20,50,50)
            }
            if(p1.dir==-1){
                drawImage(p1left,p1.x,p1.y-150+20,50,50)
            }
        }else{
            if(p1.dir==1){
                drawImage(p1rightbloody,p1.x,p1.y-150+20,50,50)
            }
            if(p1.dir==-1){
                drawImage(p1leftbloody,p1.x,p1.y-150+20,50,50)
            }
        }
        drawImage(roadroller,p1.x-150,p1.y-100+20,350,150)
    }
    context.fillStyle='blue'
    for(i=0;i<walls.length;i++){
        context.fillRect(walls[i].x,walls[i].y,walls[i].x1,walls[i].y1)
    }
    if(bt>10&&bt<15){
         drawImage(explosion1,bx-150,by-150,300,300)
    }
    if(bt>5&&bt<10){
         drawImage(explosion2,bx-150,by-150,300,300)
    }
    if(bt>0&&bt<5){
         drawImage(explosion3,bx-150,by-150,300,300)
    }
    if(p1.c==3){
        p1.hp+=0.1
        if(p1.hp>1000){p1.hp=1000}
    }
}


function keyup(key) {
	// Show the pressed keycode in the console
    if(p1.c==1){
        if(key==81){
            if(t>2500){
                t-=2500
                t3=25
                p2.dx=0
                p2.dy=0
                zawardo.play()
            }
        }
        if(key==69){
            if(t>500){
                t2=200
                t-=500
                p2.dx=0
                p2.dy=0
                ts.play()
            }
        }
        if(key==32){
            if(t>100){
                if(t2<0){
                    t-=100
                    nx[nn]=p1.x+randomInteger(10)-5
                    ny[nn]=p1.y+randomInteger(10)-5
                    nd[nn]=p1.dir*25
                    nn++
                    nx[nn]=p1.x+randomInteger(10)-5
                    ny[nn]=p1.y+16+randomInteger(10)-5
                    nd[nn]=p1.dir*25
                    nn++
                    nx[nn]=p1.x+randomInteger(10)-5
                    ny[nn]=p1.y+16+16+randomInteger(10)-5
                    nd[nn]=p1.dir*25
                    nn++
                    knifesfx.play()
                }else{
                    tsknifes.play()
                    bd=350
                }
            }
        }
        if(key==88){
            if(t>=4000){
                t-=4000
                t2=1000
                p2.dx=0
                p2.dy=0
                p1.dy=-8
                rd=1000
                roadroller2.play()
            }
        }
    }else if(p1.c==2){
        if(key==32){
            bx=p1.x+25
            by=p1.y+25
            click.play()
        }
        if(key==81){
            if(t>500){
                t-=500
                bt=16
            }
        }
        if(key==88){
            if(t>=4000){
                t-=4000
                btdt=350
                btd.play()
            }
        }
        if(key==69){
            if(t>2000){
                t-=2000
                ha=1000
                shas.play()
            }
        }
        
    }else if(p1.c==3){
        
    }
    if(key==67){
        ez.play()
    }
    if(p2.c==1){
        if(t2<0){
            if(key==97){
                if(ecd>100){
                    ecd-=100
                    ex[en]=p2.x+randomInteger(20)-10
                    ey[en]=p2.y+25+randomInteger(20)-10
                    ed[en]=p2.dir*25
                    en++
                    ex[en]=p2.x+randomInteger(20)-10
                    ey[en]=p2.y-25+25+randomInteger(20)-10
                    ed[en]=p2.dir*25
                    en++
                    ex[en]=p2.x-p2.dir*30+randomInteger(20)-10
                    ey[en]=p2.y+12.5+randomInteger(20)-10
                    ed[en]=p2.dir*25
                    en++
                    ex[en]=p2.x-p2.dir*-5+randomInteger(20)-10
                    ey[en]=p2.y+12.5+randomInteger(20)-10
                    ed[en]=p2.dir*25
                    en++
                    ex[en]=p2.x-p2.dir*20+randomInteger(20)-10
                    ey[en]=p2.y+12.5+randomInteger(20)-10
                    ed[en]=p2.dir*25
                    en++

                    emeraldsplash.play()
                }
            }
            if(key==98){
                if(ecd>1500){
                    ecd-=1000
                    ecd2=-1000
                    mx=p2.x-125
                    my=p2.y-200
                    emeraldsplash20.play()
                }
            }
            if(key==99){
                if(ecd>1000){
                    ecd-=1000
                    ecd2=-1000
                    mx2=p2.x-300
                    my2=p2.y-500
                    emeraldsplash20.play()
                }
            }
            if(key==96){
                if(ecd>=4000){
                    ecd-=4000
                    ecd3=750
                    mx3=p1.x-250
                    my3=p1.y-325
                    emeraldsplash20.play()
                }
            }
        }
    }
    if(key==105){
        annya=true
    }
}

function mouseup() {
	// Show coordinates of mouse on click
}
